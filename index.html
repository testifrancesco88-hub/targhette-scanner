<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1e293b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Targhette">
  <title>Targhette Scanner</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      min-height: 100vh;
      color: white;
      padding: 15px;
      padding-bottom: 100px;
    }
    .header { text-align: center; margin-bottom: 20px; }
    .header img { width: 50px; margin-bottom: 8px; }
    .header h1 { font-size: 22px; margin-bottom: 4px; }
    .header p { font-size: 12px; color: #94a3b8; }
    
    .card {
      background: rgba(51, 65, 85, 0.5);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid rgba(100, 116, 139, 0.3);
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #94a3b8;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .api-key-section {
      margin-bottom: 16px;
    }
    .api-key-section input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #475569;
      background: #1e293b;
      color: white;
      font-size: 14px;
    }
    .api-key-section input:focus {
      outline: none;
      border-color: #10b981;
    }
    .api-key-help {
      font-size: 11px;
      color: #64748b;
      margin-top: 8px;
    }
    .api-key-help a {
      color: #60a5fa;
      text-decoration: none;
    }
    .api-saved {
      color: #10b981;
      font-size: 12px;
      margin-top: 8px;
      display: none;
    }
    .api-saved.show { display: block; }
    
    .upload-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .upload-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 20px;
      border-radius: 12px;
      border: 2px dashed #475569;
      background: rgba(30, 41, 59, 0.5);
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upload-btn:hover, .upload-btn:active {
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.1);
    }
    .upload-btn.camera { background: #059669; border: none; }
    .upload-btn.camera:hover { background: #047857; }
    
    .preview-container {
      position: relative;
      margin-top: 12px;
    }
    .preview-container img {
      width: 100%;
      max-height: 250px;
      object-fit: contain;
      border-radius: 12px;
    }
    .preview-container .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.9);
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
    }
    
    .btn {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-primary { background: #f59e0b; color: #1e293b; }
    .btn-primary:hover:not(:disabled) { background: #d97706; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-secondary { background: #334155; color: white; margin-top: 10px; }
    .btn-print { background: #3b82f6; color: white; }
    .btn-email { background: #8b5cf6; color: white; }
    .btn-row { display: flex; gap: 10px; margin-top: 12px; }
    .btn-row .btn { flex: 1; }
    
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 30px;
      color: #f59e0b;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(245, 158, 11, 0.3);
      border-top-color: #f59e0b;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      border-radius: 12px;
      padding: 12px;
      color: #fca5a5;
      font-size: 14px;
      margin-top: 12px;
    }
    
    .results {
      background: linear-gradient(135deg, #065f46 0%, #064e3b 100%);
      border: 1px solid #10b981;
    }
    .results-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 16px;
    }
    .results-header h3 { font-size: 18px; }
    .tipo-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    .tipo-badge.b { background: #166534; }
    .tipo-badge.l { background: #92400e; }
    .tipo-badge.l3 { background: #6b21a8; }
    
    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    .result-item { text-align: center; }
    .result-item .label { font-size: 11px; color: #6ee7b7; margin-bottom: 4px; }
    .result-item .value { font-size: 24px; font-weight: bold; }
    .result-item .value.big { font-size: 28px; color: #4ade80; }
    
    .detail-table {
      width: 100%;
      font-size: 13px;
      border-collapse: collapse;
      margin-top: 12px;
    }
    .detail-table th, .detail-table td {
      padding: 8px 4px;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .detail-table th { color: #6ee7b7; font-weight: 600; font-size: 11px; }
    .detail-table .col-n { color: #4ade80; }
    .detail-table .col-v { color: #fbbf24; }
    
    .targhette-detail {
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 12px;
      margin-top: 16px;
    }
    .targhette-detail h4 {
      font-size: 13px;
      color: #6ee7b7;
      margin-bottom: 10px;
    }
    .targhetta-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 13px;
    }
    .targhetta-item:last-child { border-bottom: none; }
    
    /* Targhetta Preview */
    .targhetta-section { margin-top: 16px; }
    .targhetta-preview {
      background: white;
      width: 189px;
      min-height: 500px;
      margin: 0 auto;
      border: 2px solid #333;
      font-family: Arial, sans-serif;
      font-size: 10px;
      color: #333;
      display: flex;
      flex-direction: column;
    }
    .targhetta-preview .t-header {
      background: #1a1a2e;
      color: white;
      padding: 10px;
      text-align: center;
    }
    .targhetta-preview .t-header img { width: 35px; margin-bottom: 4px; }
    .targhetta-preview .t-header .banca { font-size: 18px; font-weight: bold; }
    .targhetta-preview .t-data {
      display: flex;
      border-bottom: 1px solid #333;
      background: #f5f5f5;
      padding: 6px 8px;
      font-size: 11px;
    }
    .targhetta-preview .t-tipo {
      display: flex;
      border-bottom: 1px solid #333;
    }
    .targhetta-preview .t-tipo > div {
      flex: 1;
      text-align: center;
      padding: 8px;
      font-weight: bold;
      font-size: 14px;
      border-right: 1px solid #333;
    }
    .targhetta-preview .t-tipo > div:last-child { border-right: none; }
    .targhetta-preview .t-tipo .sel-b { background: #166534; color: white; }
    .targhetta-preview .t-tipo .sel-l { background: #92400e; color: white; }
    .targhetta-preview .t-tipo .sel-l3 { background: #6b21a8; color: white; }
    .targhetta-preview .t-table-head {
      display: flex;
      background: #e0e0e0;
      font-weight: bold;
      font-size: 9px;
      border-bottom: 1px solid #333;
    }
    .targhetta-preview .t-table-head > div {
      padding: 6px 3px;
      text-align: center;
      border-right: 1px solid #999;
    }
    .targhetta-preview .t-table-head > div:last-child { border-right: none; }
    .targhetta-preview .t-col-taglio { width: 42px; }
    .targhetta-preview .t-col-n { width: 32px; background: #d4edda; }
    .targhetta-preview .t-col-v { width: 32px; background: #fff3cd; }
    .targhetta-preview .t-col-pezzi { flex: 1; }
    .targhetta-preview .t-table-body { flex: 1; display: flex; flex-direction: column; }
    .targhetta-preview .t-row {
      display: flex;
      border-bottom: 1px solid #ccc;
      flex: 1;
      align-items: center;
    }
    .targhetta-preview .t-row > div {
      padding: 4px 3px;
      text-align: center;
      font-size: 12px;
      border-right: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .targhetta-preview .t-row > div:last-child { border-right: none; }
    .targhetta-preview .t-row .t-col-taglio { font-weight: bold; background: #f0f0f0; }
    .targhetta-preview .t-row .t-col-n { color: #166534; font-weight: 600; }
    .targhetta-preview .t-row .t-col-v { color: #92400e; font-weight: 600; }
    .targhetta-preview .t-row .t-col-pezzi { font-weight: bold; }
    .targhetta-preview .t-total {
      display: flex;
      background: #1a1a2e;
      color: white;
      font-weight: bold;
    }
    .targhetta-preview .t-total > div {
      padding: 8px 3px;
      text-align: center;
      font-size: 12px;
      border-right: 1px solid #444;
    }
    .targhetta-preview .t-total > div:last-child { border-right: none; }
    .targhetta-preview .t-total .t-col-n { background: #166534; color: #4ade80; }
    .targhetta-preview .t-total .t-col-v { background: #7c5e00; color: #fbbf24; }
    .targhetta-preview .t-footer {
      background: #f0f0f0;
      padding: 6px;
      text-align: center;
      font-size: 8px;
      color: #666;
      border-top: 1px solid #333;
    }
    
    .hidden { display: none !important; }
    
    @media print {
      body { background: white; padding: 0; }
      .no-print { display: none !important; }
      .targhetta-preview { 
        width: 5cm; 
        min-height: 15cm; 
        margin: 0;
      }
    }
  </style>
</head>
<body>
  <div class="header no-print">
    <img src="data:image/webp;base64,UklGRmwRAABXRUJQVlA4WAoAAAAgAAAAWAEAYwEASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZWUDggfg8AAJBYAJ0BKlkBZAE+USiSRiOioaEjMUk4cAoJZ27hdI4r9UGd+CWE+k1KY3DSD+pt8d5nfOAfSP1i/u3Zh/Q/6T+OXZcd4PaLk9xFPiX19/Tf1n0Q74/jz/a+oF+L/y//Ib6mAD66+dt8x5zeIFwLVADyYP8L9ovTT9Y+wuJ09BLZpQU9BLZpQU9BLZpQU9BLZpQU9BLZpQU9BLZoAF8lf8wvBSp6CWzSgp6CVLsTPugOqWQ/QS2aUFPQS2WwmoSUnYoF7kqR1PQS2aUFPQSpdWi92XNCGY/17Hz6GPZU9BLZpP4GqYgOedgP+BZAVF/jSp6CWqtV8wTHY6P7X/E3Qic1CKgp6B/aEjNoK3wAJTGoa/HRSGsswOhz+ZR+Gs4KjjS1KO+U2xX1tTzK+ksnWWExZNGGxWzQhzNN3O2+LEAEj8E5tczKWMglqsWXisbqbg+uNIm7Xiso8GYtF+d7m2BStQOGuu1p3b+WEijO4CpR4rfgYoBv9J8MBNfnYr8FgVHurmiODwKi7O87MqbYkCfh+/vvTMlRwoG9Tto1oFfznl//96Kanvw5Z/VeO9rkp6CWyvp4Ezom/ZhcwtlycGSo4ANiBGqKrPoZq7O5t9T0YuGeyp6CWyrF2SbdPxZpYtMv4lummCgBWylwkUR+pkb0jR/Xn95VxjNKCnoIAsbZx6WqaEJYoeJk5XHDTvnvx2Gr5eHrgQFHBmSnz1mW0mRVoqCnoJapcx7XVeO8aqkM9zoLlEuwv/8NkINcJv73Mu8AVCnFocbqlT0EtmfcbxSK5K2D4IcfLqXUW4og2epSYBuJV6A8yLawrZpQU0sa+1KZ0gxWNwZlFlfPy+G60Ek8i6Ih1ccOBlZ8G0kRUFPHcD0poo+C4fGQFOPAd7kudrWHCGash7KnoJbNKCnoJbNKCnoJbNKCnoJbNKCnoJbNKCnoJbNJ+wAD+/EsAAAAA==" alt="Logo">
    <h1>Targhette Scanner</h1>
    <p>Scansiona e somma automaticamente</p>
  </div>

  <!-- API Key Section -->
  <div id="apiSection" class="card no-print">
    <div class="card-title">üîë API Key Gemini</div>
    <div class="api-key-section">
      <input type="password" id="apiKey" placeholder="Inserisci la tua API key Gemini">
      <p class="api-key-help">
        Ottieni gratis la tua API key su <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
      </p>
      <p id="apiSaved" class="api-saved">‚úì API Key salvata</p>
    </div>
  </div>

  <!-- Upload Section -->
  <div id="uploadSection" class="card no-print">
    <div class="card-title">üì∏ Scansiona Targhette</div>
    <div class="upload-section">
      <label class="upload-btn camera">
        <span>üì∑</span> Scatta Foto
        <input type="file" accept="image/*" capture="environment" id="cameraInput" hidden>
      </label>
      <label class="upload-btn">
        <span>üñºÔ∏è</span> Carica Immagine
        <input type="file" accept="image/*" id="fileInput" hidden>
      </label>
    </div>
    <div id="previewContainer" class="preview-container hidden">
      <img id="preview" src="" alt="Preview">
      <button class="remove-btn" onclick="removeImage()">√ó</button>
    </div>
    <button id="analyzeBtn" class="btn btn-primary hidden" onclick="analyzeImage()">
      üîç ANALIZZA TARGHETTE
    </button>
    <div id="errorMsg" class="error hidden"></div>
  </div>

  <!-- Loading -->
  <div id="loadingSection" class="card hidden no-print">
    <div class="loading">
      <div class="spinner"></div>
      <span>Analisi in corso...</span>
    </div>
  </div>

  <!-- Results -->
  <div id="resultsSection" class="card results hidden no-print">
    <div class="results-header">
      <h3>üìã RIEPILOGO</h3>
      <span id="tipoBadge" class="tipo-badge b">BUONO</span>
    </div>
    <div class="results-grid">
      <div class="result-item">
        <div class="label">TOTALE PEZZI</div>
        <div class="value" id="totPezzi">0</div>
      </div>
      <div class="result-item">
        <div class="label">TOTALE EURO</div>
        <div class="value big" id="totEuro">‚Ç¨0</div>
      </div>
      <div class="result-item">
        <div class="label">NUOVE (N)</div>
        <div class="value col-n" id="totN">0</div>
      </div>
      <div class="result-item">
        <div class="label">VECCHIE (V)</div>
        <div class="value col-v" id="totV">0</div>
      </div>
    </div>
    
    <table class="detail-table">
      <thead>
        <tr><th>Taglio</th><th>N</th><th>V</th><th>Pezzi</th><th>Euro</th></tr>
      </thead>
      <tbody id="detailBody"></tbody>
    </table>
    
    <div class="targhette-detail">
      <h4>üìù Dettaglio Targhette Analizzate</h4>
      <div id="targhetteDetail"></div>
    </div>
    
    <button class="btn btn-success" onclick="mostraTarghetta()">üìÑ GENERA TARGHETTA</button>
    <button class="btn btn-secondary" onclick="reset()">üîÑ Nuova Scansione</button>
  </div>

  <!-- Targhetta Preview -->
  <div id="targhettaSection" class="card targhetta-section hidden">
    <div class="card-title no-print">üìÑ Targhetta Riepilogativa (5√ó15cm)</div>
    <div id="targhettaPreview"></div>
    <div class="btn-row no-print">
      <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Stampa</button>
      <button class="btn btn-email" onclick="inviaEmail()">üìß Email</button>
    </div>
  </div>

  <script>
    const LOGO_BASE64 = "data:image/webp;base64,UklGRmwRAABXRUJQVlA4WAoAAAAgAAAAWAEAYwEASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZWUDggfg8AAJBYAJ0BKlkBZAE+USiSRiOioaEjMUk4cAoJZ27hdI4r9UGd+CWE+k1KY3DSD+pt8d5nfOAfSP1i/u3Zh/Q/6T+OXZcd4PaLk9xFPiX19/Tf1n0Q74/jz/a+oF+L/y//Ib6mAD66+dt8x5zeIFwLVADyYP8L9ovTT9Y+wuJ09BLZpQU9BLZpQU9BLZpQU9BLZpQU9BLZpQU9BLZoAF8lf8wvBSp6CWzSgp6CVLsTPugOqWQ/QS2aUFPQS2WwmoSUnYoF7kqR1PQS2aUFPQSpdWi92XNCGY/17Hz6GPZU9BLZpP4GqYgOedgP+BZAVF/jSp6CWqtV8wTHY6P7X/E3Qic1CKgp6B/aEjNoK3wAJTGoa/HRSGsswOhz+ZR+Gs4KjjS1KO+U2xX1tTzK+ksnWWExZNGGxWzQhzNN3O2+LEAEj8E5tczKWMglqsWXisbqbg+uNIm7Xiso8GYtF+d7m2BStQOGuu1p3b+WEijO4CpR4rfgYoBv9J8MBNfnYr8FgVHurmiODwKi7O87MqbYkCfh+/vvTMlRwoG9Tto1oFfznl//96Kanvw5Z/VeO9rkp6CWyvp4Ezom/ZhcwtlycGSo4ANiBGqKrPoZq7O5t9T0YuGeyp6CWyrF2SbdPxZpYtMv4lummCgBWylwkUR+pkb0jR/Xn95VxjNKCnoIAsbZx6WqaEJYoeJk5XHDTvnvx2Gr5eHrgQFHBmSnz1mW0mRVoqCnoJapcx7XVeO8aqkM9zoLlEuwv/8NkINcJv73Mu8AVCnFocbqlT0EtmfcbxSK5K2D4IcfLqXUW4og2epSYBuJV6A8yLawrZpQU0sa+1KZ0gxWNwZlFlfPy+G60Ek8i6Ih1ccOBlZ8G0kRUFPHcD0poo+C4fGQFOPAd7kudrWHCGash7KnoJbNKCnoJbNKCnoJbNKCnoJbNKCnoJbNKCnoJbNJ+wAD+/EsAAAAA==";
    
    let imageData = null;
    let results = null;
    
    // Load API key from localStorage
    const savedApiKey = localStorage.getItem('gemini_api_key');
    if (savedApiKey) {
      document.getElementById('apiKey').value = savedApiKey;
      document.getElementById('apiSaved').classList.add('show');
    }
    
    // Save API key on change
    document.getElementById('apiKey').addEventListener('change', (e) => {
      localStorage.setItem('gemini_api_key', e.target.value);
      document.getElementById('apiSaved').classList.add('show');
    });
    
    // File input handlers
    document.getElementById('cameraInput').addEventListener('change', handleImageSelect);
    document.getElementById('fileInput').addEventListener('change', handleImageSelect);
    
    function handleImageSelect(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        imageData = e.target.result;
        document.getElementById('preview').src = imageData;
        document.getElementById('previewContainer').classList.remove('hidden');
        document.getElementById('analyzeBtn').classList.remove('hidden');
        document.getElementById('errorMsg').classList.add('hidden');
      };
      reader.readAsDataURL(file);
    }
    
    function removeImage() {
      imageData = null;
      document.getElementById('previewContainer').classList.add('hidden');
      document.getElementById('analyzeBtn').classList.add('hidden');
      document.getElementById('cameraInput').value = '';
      document.getElementById('fileInput').value = '';
    }
    
    async function analyzeImage() {
      const apiKey = document.getElementById('apiKey').value.trim();
      if (!apiKey) {
        showError('Inserisci la tua API Key Gemini');
        return;
      }
      if (!imageData) {
        showError('Seleziona un\'immagine');
        return;
      }
      
      document.getElementById('uploadSection').classList.add('hidden');
      document.getElementById('loadingSection').classList.remove('hidden');
      document.getElementById('errorMsg').classList.add('hidden');
      
      try {
        const base64Data = imageData.split(',')[1];
        
        const prompt = `Analizza questa immagine che contiene targhette di conteggio banconote italiane.

Ogni targhetta ha:
- Una banca (es. MPS, Intesa, etc.)
- Una data (formato GG/MM/AAAA)
- TRE RIQUADRI con le lettere B, L, L3 - UNO ha una X segnata (B=Buono, L=Logoro, L3)
- Tagli: 500, 200, 100, 50, 20, 10, 5
- Per 200 e 100: potrebbero esserci valori N (Nuove) e V (Vecchie) separati

Rispondi SOLO con JSON valido (nessun testo prima o dopo):
{
  "targhette": [
    {
      "banca": "nome",
      "data": "GG/MM/AAAA",
      "tipo": "B" o "L" o "L3",
      "valori": {
        "500": {"pezzi": numero},
        "200": {"pezzi": numero, "nuove": numero_o_0, "vecchie": numero_o_0},
        "100": {"pezzi": numero, "nuove": numero_o_0, "vecchie": numero_o_0},
        "50": {"pezzi": numero},
        "20": {"pezzi": numero},
        "10": {"pezzi": numero},
        "5": {"pezzi": numero}
      }
    }
  ]
}`;

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'x-goog-api-key': apiKey
          },
          body: JSON.stringify({
            contents: [{
              parts: [
                { text: prompt },
                { inline_data: { mime_type: 'image/jpeg', data: base64Data } }
              ]
            }]
          })
        });
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error.message || 'Errore API Gemini');
        }
        
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        
        if (!jsonMatch) {
          throw new Error('Risposta non valida. Riprova con una foto pi√π chiara.');
        }
        
        const parsed = JSON.parse(jsonMatch[0]);
        processResults(parsed);
        
      } catch (error) {
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('uploadSection').classList.remove('hidden');
        showError(error.message || 'Errore durante l\'analisi');
      }
    }
    
    function processResults(data) {
      const tagli = [500, 200, 100, 50, 20, 10, 5];
      
      // Check same type
      const types = data.targhette.map(t => t.tipo).filter(Boolean);
      const uniqueTypes = [...new Set(types)];
      if (uniqueTypes.length > 1) {
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('uploadSection').classList.remove('hidden');
        showError(`Le targhette non sono dello stesso tipo! Trovati: ${uniqueTypes.join(', ')}`);
        return;
      }
      
      const tipo = uniqueTypes[0] || 'B';
      const banca = data.targhette[0]?.banca || 'BANCA';
      const dataStr = data.targhette[0]?.data || new Date().toLocaleDateString('it-IT');
      
      // Calculate totals
      const totali = {};
      let totPezzi = 0, totEuro = 0, totN = 0, totV = 0;
      
      tagli.forEach(tag => {
        let pezzi = 0, nuove = 0, vecchie = 0;
        data.targhette.forEach(t => {
          const v = t.valori[tag];
          if (v) {
            pezzi += v.pezzi || 0;
            nuove += v.nuove || 0;
            vecchie += v.vecchie || 0;
          }
        });
        totali[tag] = { pezzi, nuove, vecchie, euro: pezzi * tag };
        totPezzi += pezzi;
        totEuro += pezzi * tag;
        totN += nuove;
        totV += vecchie;
      });
      
      results = {
        targhette: data.targhette,
        totali,
        tipo,
        banca,
        data: dataStr,
        totPezzi,
        totEuro,
        totN,
        totV
      };
      
      // Update UI
      document.getElementById('loadingSection').classList.add('hidden');
      document.getElementById('resultsSection').classList.remove('hidden');
      
      const badge = document.getElementById('tipoBadge');
      badge.textContent = tipo === 'B' ? 'BUONO' : tipo === 'L' ? 'LOGORO' : 'L3';
      badge.className = 'tipo-badge ' + tipo.toLowerCase();
      
      document.getElementById('totPezzi').textContent = totPezzi;
      document.getElementById('totEuro').textContent = '‚Ç¨' + totEuro.toLocaleString('it-IT');
      document.getElementById('totN').textContent = totN;
      document.getElementById('totV').textContent = totV;
      
      // Detail table
      let html = '';
      tagli.forEach(tag => {
        const t = totali[tag];
        const hasNV = tag === 200 || tag === 100;
        html += `<tr>
          <td>‚Ç¨${tag}</td>
          <td class="col-n">${hasNV ? t.nuove : '-'}</td>
          <td class="col-v">${hasNV ? t.vecchie : '-'}</td>
          <td>${t.pezzi}</td>
          <td>‚Ç¨${t.euro.toLocaleString('it-IT')}</td>
        </tr>`;
      });
      document.getElementById('detailBody').innerHTML = html;
      
      // Targhette detail
      let detailHtml = '';
      data.targhette.forEach((t, i) => {
        let sum = 0;
        tagli.forEach(tag => { sum += (t.valori[tag]?.pezzi || 0) * tag; });
        detailHtml += `<div class="targhetta-item">
          <span>Targhetta ${i + 1}: ${t.banca} - ${t.data}</span>
          <span>‚Ç¨${sum.toLocaleString('it-IT')}</span>
        </div>`;
      });
      document.getElementById('targhetteDetail').innerHTML = detailHtml;
      
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }
    
    function mostraTarghetta() {
      if (!results) return;
      
      const tagli = [500, 200, 100, 50, 20, 10, 5];
      let rows = '';
      tagli.forEach(tag => {
        const t = results.totali[tag];
        const hasNV = tag === 200 || tag === 100;
        rows += `<div class="t-row">
          <div class="t-col-taglio">${tag}</div>
          <div class="t-col-n">${hasNV ? t.nuove : '-'}</div>
          <div class="t-col-v">${hasNV ? t.vecchie : '-'}</div>
          <div class="t-col-pezzi">${t.pezzi}</div>
        </div>`;
      });
      
      const tipoClass = 'sel-' + results.tipo.toLowerCase();
      
      document.getElementById('targhettaPreview').innerHTML = `
        <div class="targhetta-preview">
          <div class="t-header">
            <img src="${LOGO_BASE64}" alt="Logo">
            <div class="banca">${results.banca}</div>
          </div>
          <div class="t-data"><strong>Data:</strong>&nbsp;${results.data}</div>
          <div class="t-tipo">
            <div class="${results.tipo === 'B' ? tipoClass : ''}">B ${results.tipo === 'B' ? '‚úì' : ''}</div>
            <div class="${results.tipo === 'L' ? tipoClass : ''}">L ${results.tipo === 'L' ? '‚úì' : ''}</div>
            <div class="${results.tipo === 'L3' ? tipoClass : ''}">L3 ${results.tipo === 'L3' ? '‚úì' : ''}</div>
          </div>
          <div class="t-table-head">
            <div class="t-col-taglio">TAGLIO</div>
            <div class="t-col-n">N</div>
            <div class="t-col-v">V</div>
            <div class="t-col-pezzi">PEZZI</div>
          </div>
          <div class="t-table-body">${rows}</div>
          <div class="t-total">
            <div class="t-col-taglio">TOT</div>
            <div class="t-col-n">${results.totN}</div>
            <div class="t-col-v">${results.totV}</div>
            <div class="t-col-pezzi">${results.totPezzi}</div>
          </div>
          <div class="t-footer">Somma ${results.targhette.length} targhette ‚Ä¢ ‚Ç¨${results.totEuro.toLocaleString('it-IT')}</div>
        </div>
      `;
      
      document.getElementById('targhettaSection').classList.remove('hidden');
      document.getElementById('targhettaSection').scrollIntoView({ behavior: 'smooth' });
    }
    
    function inviaEmail() {
      if (!results) return;
      
      const tipoLabel = results.tipo === 'B' ? 'BUONO' : results.tipo === 'L' ? 'LOGORO' : 'L3';
      const subject = `Targhetta ${results.banca} - ${tipoLabel} - ${results.data} - ‚Ç¨${results.totEuro.toLocaleString('it-IT')}`;
      
      let body = `TARGHETTA RIEPILOGATIVA\n========================\n\nBanca: ${results.banca}\nData: ${results.data}\nTipo: ${tipoLabel}\n\nDETTAGLIO:\n----------\n`;
      
      [500, 200, 100, 50, 20, 10, 5].forEach(tag => {
        const t = results.totali[tag];
        const nv = (tag === 200 || tag === 100) ? ` (N:${t.nuove} V:${t.vecchie})` : '';
        body += `‚Ç¨${tag}: ${t.pezzi} pz${nv} = ‚Ç¨${t.euro.toLocaleString('it-IT')}\n`;
      });
      
      body += `\n========================\nTOTALE: ${results.totPezzi} pz = ‚Ç¨${results.totEuro.toLocaleString('it-IT')}\nNuove: ${results.totN} | Vecchie: ${results.totV}\n========================\n\nGenerato da Targhette Scanner - Battistolli`;
      
      window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }
    
    function showError(msg) {
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.classList.remove('hidden');
    }
    
    function reset() {
      imageData = null;
      results = null;
      document.getElementById('previewContainer').classList.add('hidden');
      document.getElementById('analyzeBtn').classList.add('hidden');
      document.getElementById('resultsSection').classList.add('hidden');
      document.getElementById('targhettaSection').classList.add('hidden');
      document.getElementById('uploadSection').classList.remove('hidden');
      document.getElementById('cameraInput').value = '';
      document.getElementById('fileInput').value = '';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  </script>
</body>
</html>
