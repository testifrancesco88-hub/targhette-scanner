<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1e293b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Targhette">
  <title>Targhette Scanner</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      min-height: 100vh;
      color: white;
      padding: 15px;
      padding-bottom: 100px;
    }
    .header { text-align: center; margin-bottom: 20px; }
    .header img { width: 50px; margin-bottom: 8px; }
    .header h1 { font-size: 22px; margin-bottom: 4px; }
    .header p { font-size: 12px; color: #94a3b8; }
    
    .card {
      background: rgba(51, 65, 85, 0.5);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid rgba(100, 116, 139, 0.3);
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #94a3b8;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .api-key-section {
      margin-bottom: 16px;
    }
    .api-key-section input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #475569;
      background: #1e293b;
      color: white;
      font-size: 14px;
    }
    .api-key-section input:focus {
      outline: none;
      border-color: #10b981;
    }
    .api-key-help {
      font-size: 11px;
      color: #64748b;
      margin-top: 8px;
    }
    .api-key-help a {
      color: #60a5fa;
      text-decoration: none;
    }
    .api-saved {
      color: #10b981;
      font-size: 12px;
      margin-top: 8px;
      display: none;
    }
    .api-saved.show { display: block; }
    
    .upload-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .upload-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 20px;
      border-radius: 12px;
      border: 2px dashed #475569;
      background: rgba(30, 41, 59, 0.5);
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upload-btn:hover, .upload-btn:active {
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.1);
    }
    .upload-btn.camera { background: #059669; border: none; }
    .upload-btn.camera:hover { background: #047857; }
    
    .preview-container {
      position: relative;
      margin-top: 12px;
    }
    .preview-container img {
      width: 100%;
      max-height: 250px;
      object-fit: contain;
      border-radius: 12px;
    }
    .preview-container .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.9);
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
    }
    
    .btn {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-primary { background: #f59e0b; color: #1e293b; }
    .btn-primary:hover:not(:disabled) { background: #d97706; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-secondary { background: #334155; color: white; margin-top: 10px; }
    .btn-print { background: #3b82f6; color: white; }
    .btn-email { background: #8b5cf6; color: white; }
    .btn-row { display: flex; gap: 10px; margin-top: 12px; }
    .btn-row .btn { flex: 1; }
    
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 30px;
      color: #f59e0b;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(245, 158, 11, 0.3);
      border-top-color: #f59e0b;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      border-radius: 12px;
      padding: 12px;
      color: #fca5a5;
      font-size: 14px;
      margin-top: 12px;
    }
    
    .results {
      background: linear-gradient(135deg, #065f46 0%, #064e3b 100%);
      border: 1px solid #10b981;
    }
    .results-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 16px;
    }
    .results-header h3 { font-size: 18px; }
    .tipo-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    .tipo-badge.b { background: #166534; }
    .tipo-badge.l { background: #92400e; }
    .tipo-badge.l3 { background: #6b21a8; }
    
    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    .result-item { text-align: center; }
    .result-item .label { font-size: 11px; color: #6ee7b7; margin-bottom: 4px; }
    .result-item .value { font-size: 24px; font-weight: bold; }
    .result-item .value.big { font-size: 28px; color: #4ade80; }
    
    .detail-table {
      width: 100%;
      font-size: 13px;
      border-collapse: collapse;
      margin-top: 12px;
    }
    .detail-table th, .detail-table td {
      padding: 8px 4px;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .detail-table th { color: #6ee7b7; font-weight: 600; font-size: 11px; }
    .detail-table .col-n { color: #4ade80; }
    .detail-table .col-v { color: #fbbf24; }
    
    .targhette-detail {
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 12px;
      margin-top: 16px;
    }
    .targhette-detail h4 {
      font-size: 13px;
      color: #6ee7b7;
      margin-bottom: 10px;
    }
    .targhetta-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 13px;
    }
    .targhetta-item:last-child { border-bottom: none; }
    
    /* Targhetta Preview */
    .targhetta-section { margin-top: 16px; }
    .targhetta-preview {
      background: white;
      width: 189px;
      min-height: 500px;
      margin: 0 auto;
      border: 2px solid #333;
      font-family: Arial, sans-serif;
      font-size: 10px;
      color: #333;
      display: flex;
      flex-direction: column;
    }
    .targhetta-preview .t-header {
      background: #1a1a2e;
      color: white;
      padding: 10px;
      text-align: center;
    }
    .targhetta-preview .t-header img { width: 35px; margin-bottom: 4px; }
    .targhetta-preview .t-header .banca { font-size: 18px; font-weight: bold; }
    .targhetta-preview .t-data {
      display: flex;
      border-bottom: 1px solid #333;
      background: #f5f5f5;
      padding: 6px 8px;
      font-size: 11px;
    }
    .targhetta-preview .t-tipo {
      display: flex;
      border-bottom: 1px solid #333;
    }
    .targhetta-preview .t-tipo > div {
      flex: 1;
      text-align: center;
      padding: 8px;
      font-weight: bold;
      font-size: 14px;
      border-right: 1px solid #333;
    }
    .targhetta-preview .t-tipo > div:last-child { border-right: none; }
    .targhetta-preview .t-tipo .sel-b { background: #166534; color: white; }
    .targhetta-preview .t-tipo .sel-l { background: #92400e; color: white; }
    .targhetta-preview .t-tipo .sel-l3 { background: #6b21a8; color: white; }
    .targhetta-preview .t-table-head {
      display: flex;
      background: #e0e0e0;
      font-weight: bold;
      font-size: 9px;
      border-bottom: 1px solid #333;
    }
    .targhetta-preview .t-table-head > div {
      padding: 6px 3px;
      text-align: center;
      border-right: 1px solid #999;
    }
    .targhetta-preview .t-table-head > div:last-child { border-right: none; }
    .targhetta-preview .t-col-taglio { width: 42px; }
    .targhetta-preview .t-col-n { width: 32px; background: #d4edda; }
    .targhetta-preview .t-col-v { width: 32px; background: #fff3cd; }
    .targhetta-preview .t-col-pezzi { flex: 1; }
    .targhetta-preview .t-table-body { flex: 1; display: flex; flex-direction: column; }
    .targhetta-preview .t-row {
      display: flex;
      border-bottom: 1px solid #ccc;
      flex: 1;
      align-items: center;
    }
    .targhetta-preview .t-row > div {
      padding: 4px 3px;
      text-align: center;
      font-size: 12px;
      border-right: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .targhetta-preview .t-row > div:last-child { border-right: none; }
    .targhetta-preview .t-row .t-col-taglio { font-weight: bold; background: #f0f0f0; }
    .targhetta-preview .t-row .t-col-n { color: #166534; font-weight: 600; }
    .targhetta-preview .t-row .t-col-v { color: #92400e; font-weight: 600; }
    .targhetta-preview .t-row .t-col-pezzi { font-weight: bold; }
    .targhetta-preview .t-total {
      display: flex;
      background: #1a1a2e;
      color: white;
      font-weight: bold;
    }
    .targhetta-preview .t-total > div {
      padding: 8px 3px;
      text-align: center;
      font-size: 12px;
      border-right: 1px solid #444;
    }
    .targhetta-preview .t-total > div:last-child { border-right: none; }
    .targhetta-preview .t-total .t-col-n { background: #166534; color: #4ade80; }
    .targhetta-preview .t-total .t-col-v { background: #7c5e00; color: #fbbf24; }
    .targhetta-preview .t-footer {
      background: #f0f0f0;
      padding: 6px;
      text-align: center;
      font-size: 8px;
      color: #666;
      border-top: 1px solid #333;
    }
    
    .hidden { display: none !important; }
    
    /* Mode Toggle */
    .mode-toggle { padding: 8px; }
    .mode-buttons {
      display: flex;
      gap: 8px;
    }
    .mode-btn {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: 2px solid #475569;
      background: transparent;
      color: #94a3b8;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .mode-btn.active {
      background: #10b981;
      border-color: #10b981;
      color: white;
    }
    
    /* Manual Input */
    .manual-section { }
    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }
    .form-group { flex: 1; }
    .form-group label {
      display: block;
      font-size: 11px;
      color: #94a3b8;
      margin-bottom: 4px;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #475569;
      background: #1e293b;
      color: white;
      font-size: 14px;
    }
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #10b981;
    }
    .tipo-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .tipo-btn {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: 2px solid #475569;
      background: transparent;
      color: #94a3b8;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tipo-btn.active-b { background: #166534; border-color: #22c55e; color: white; }
    .tipo-btn.active-l { background: #92400e; border-color: #f59e0b; color: white; }
    .tipo-btn.active-l3 { background: #6b21a8; border-color: #a855f7; color: white; }
    .tagli-grid {
      display: grid;
      grid-template-columns: auto 1fr 1fr 1fr;
      gap: 6px;
      align-items: center;
    }
    .tagli-grid .header {
      font-size: 11px;
      color: #94a3b8;
      text-align: center;
      padding: 4px;
    }
    .tagli-grid .taglio-label {
      font-weight: bold;
      color: #e2e8f0;
      font-size: 14px;
      padding: 8px 4px;
    }
    .tagli-grid input {
      padding: 10px 4px;
      border-radius: 6px;
      border: 1px solid #475569;
      background: #1e293b;
      color: white;
      font-size: 14px;
      text-align: center;
      width: 100%;
    }
    .tagli-grid input:focus {
      outline: none;
      border-color: #10b981;
    }
    .tagli-grid input.col-n { border-color: #166534; }
    .tagli-grid input.col-v { border-color: #92400e; }
    .tagli-grid input.col-n:focus { border-color: #22c55e; }
    .tagli-grid input.col-v:focus { border-color: #f59e0b; }
    .targhetta-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .targhetta-tab {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 2px solid #475569;
      background: transparent;
      color: #94a3b8;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .targhetta-tab.active {
      background: #334155;
      border-color: #10b981;
      color: white;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    @media print {
      body { background: white; padding: 0; }
      .no-print { display: none !important; }
      .targhetta-preview { 
        width: 5cm; 
        min-height: 15cm; 
        margin: 0;
      }
    }
  </style>
</head>
<body>
  <div class="header no-print">
    <img src="icon-192.png" alt="Logo">
    <h1>Targhette Scanner</h1>
    <p>Scansiona e somma automaticamente</p>
  </div>

  <!-- Mode Toggle -->
  <div class="card no-print mode-toggle">
    <div class="mode-buttons">
      <button class="mode-btn active" onclick="setMode('auto')" id="modeAuto">üì∑ Automatico</button>
      <button class="mode-btn" onclick="setMode('manual')" id="modeManual">‚úèÔ∏è Manuale</button>
    </div>
  </div>

  <!-- API Key Section -->
  <div id="apiSection" class="card no-print">
    <div class="card-title">üîë API Key Gemini</div>
    <div class="api-key-section">
      <input type="password" id="apiKey" placeholder="Inserisci la tua API key Gemini">
      <p class="api-key-help">
        Ottieni gratis la tua API key su <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
      </p>
      <p id="apiSaved" class="api-saved">‚úì API Key salvata</p>
    </div>
  </div>

  <!-- Upload Section -->
  <div id="uploadSection" class="card no-print">
    <div class="card-title">üì∏ Scansiona Targhette</div>
    <div class="upload-section">
      <label class="upload-btn camera">
        <span>üì∑</span> Scatta Foto
        <input type="file" accept="image/*" capture="environment" id="cameraInput" hidden>
      </label>
      <label class="upload-btn">
        <span>üñºÔ∏è</span> Carica Immagine
        <input type="file" accept="image/*" id="fileInput" hidden>
      </label>
    </div>
    <div id="previewContainer" class="preview-container hidden">
      <img id="preview" src="" alt="Preview">
      <button class="remove-btn" onclick="removeImage()">√ó</button>
    </div>
    <button id="analyzeBtn" class="btn btn-primary hidden" onclick="analyzeImage()">
      üîç ANALIZZA TARGHETTE
    </button>
    <div id="errorMsg" class="error hidden"></div>
  </div>

  <!-- Loading -->
  <div id="loadingSection" class="card hidden no-print">
    <div class="loading">
      <div class="spinner"></div>
      <span>Analisi in corso...</span>
    </div>
  </div>

  <!-- Manual Input Section -->
  <div id="manualSection" class="card manual-section hidden no-print">
    <div class="card-title">üìã Informazioni</div>
    <div class="form-row">
      <div class="form-group">
        <label>Banca</label>
        <select id="manualBanca">
          <option value="MPS">MPS</option>
          <option value="Intesa">Intesa S.Paolo</option>
          <option value="Unicredit">Unicredit</option>
          <option value="BPM">BPM</option>
          <option value="BPER">BPER</option>
          <option value="Altro">Altro</option>
        </select>
      </div>
      <div class="form-group">
        <label>Data</label>
        <input type="date" id="manualData">
      </div>
    </div>
    
    <div class="card-title" style="margin-top:8px">Tipo</div>
    <div class="tipo-selector">
      <button class="tipo-btn active-b" data-tipo="B" onclick="setTipoManual('B')">B</button>
      <button class="tipo-btn" data-tipo="L" onclick="setTipoManual('L')">L</button>
      <button class="tipo-btn" data-tipo="L3" onclick="setTipoManual('L3')">L3</button>
    </div>
    
    <div class="card-title" style="margin-top:12px">üè∑Ô∏è Valori Targhette</div>
    <div class="targhetta-tabs">
      <button class="targhetta-tab active" onclick="showManualTab(1)">Targhetta 1</button>
      <button class="targhetta-tab" onclick="showManualTab(2)">Targhetta 2</button>
    </div>
    
    <!-- Tab 1 -->
    <div id="manualTab1" class="tab-content active">
      <div class="tagli-grid">
        <div class="header">Taglio</div>
        <div class="header" style="color:#22c55e">N</div>
        <div class="header" style="color:#f59e0b">V</div>
        <div class="header">Pezzi</div>
        
        <div class="taglio-label">‚Ç¨500</div>
        <div>-</div>
        <div>-</div>
        <input type="number" inputmode="numeric" id="m1_500" value="0">
        
        <div class="taglio-label">‚Ç¨200</div>
        <input type="number" inputmode="numeric" class="col-n" id="m1_200n" value="0" onchange="updateManualTotal(1,200)">
        <input type="number" inputmode="numeric" class="col-v" id="m1_200v" value="0" onchange="updateManualTotal(1,200)">
        <input type="number" inputmode="numeric" id="m1_200" readonly>
        
        <div class="taglio-label">‚Ç¨100</div>
        <input type="number" inputmode="numeric" class="col-n" id="m1_100n" value="0" onchange="updateManualTotal(1,100)">
        <input type="number" inputmode="numeric" class="col-v" id="m1_100v" value="0" onchange="updateManualTotal(1,100)">
        <input type="number" inputmode="numeric" id="m1_100" readonly>
        
        <div class="taglio-label">‚Ç¨50</div>
        <div>-</div>
        <div>-</div>
        <input type="number" inputmode="numeric" id="m1_50" value="0">
        
        <div class="taglio-label">‚Ç¨20</div>
        <div>-</div>
        <div>-</div>
        <input type="number" inputmode="numeric" id="m1_20" value="0">
        
        <div class="taglio-label">‚Ç¨10</div>
        <div>-</div>
        <div>-</div>
        <input type="number" inputmode="numeric" id="m1_10" value="0">
        
        <div class="taglio-label">‚Ç¨5</div>
        <div>-</div>
        <div>-</div>
        <input type="number" inputmode="numeric" id="m1_5" value="0">
      </div>
    </div>
    
    <!-- Tab 2 -->
    <div id="manualTab2" class="tab-content">
      <div class="tagli-grid">
        <div class="header">Taglio</div>
        <div class="header" style="color:#22c55e">N</div>
        <div class="header" style="color:#f59e0b">V</div>
        <div class="header">Pezzi</div>
        
        <div class="taglio-label">‚Ç¨500</div>
        <div>-</div>
        <div>-</div>
        <input type="number" inputmode="numeric" id="m2_500" value="0">
        
        <div class="taglio-label">‚Ç¨200</div>
        <input type="number" inputmode="numeric" class="col-n" id="m2_200n" value="0" onchange="updateManualTotal(2,200)">
        <input type="number" inputmode="numeric" class="col-v" id="m2_200v" value="0" onchange="updateManualTotal(2,200)">
        <input type="number" inputmode="numeric" id="m2_200" readonly>
        
        <div class="taglio-label">‚Ç¨100</div>
        <input type="number" inputmode="numeric" class="col-n" id="m2_100n" value="0" onchange="updateManualTotal(2,100)">
        <input type="number" inputmode="numeric" class="col-v" id="m2_100v" value="0" onchange="updateManualTotal(2,100)">
        <input type="number" inputmode="numeric" id="m2_100" readonly>
        
        <div class="taglio-label">‚Ç¨50</div>
        <div>-</div>
        <div>-</div>
        <input type="number" inputmode="numeric" id="m2_50" value="0">
        
        <div class="taglio-label">‚Ç¨20</div>
        <div>-</div>
        <div>-</div>
        <input type="number" inputmode="numeric" id="m2_20" value="0">
        
        <div class="taglio-label">‚Ç¨10</div>
        <div>-</div>
        <div>-</div>
        <input type="number" inputmode="numeric" id="m2_10" value="0">
        
        <div class="taglio-label">‚Ç¨5</div>
        <div>-</div>
        <div>-</div>
        <input type="number" inputmode="numeric" id="m2_5" value="0">
      </div>
    </div>
    
    <button class="btn btn-primary" onclick="calcolaManuale()" style="margin-top:16px">üìä CALCOLA TOTALI</button>
  </div>

  <!-- Results -->
  <div id="resultsSection" class="card results hidden no-print">
    <div class="results-header">
      <h3>üìã RIEPILOGO</h3>
      <span id="tipoBadge" class="tipo-badge b">BUONO</span>
    </div>
    <div class="results-grid">
      <div class="result-item">
        <div class="label">TOTALE PEZZI</div>
        <div class="value" id="totPezzi">0</div>
      </div>
      <div class="result-item">
        <div class="label">TOTALE EURO</div>
        <div class="value big" id="totEuro">‚Ç¨0</div>
      </div>
      <div class="result-item">
        <div class="label">NUOVE (N)</div>
        <div class="value col-n" id="totN">0</div>
      </div>
      <div class="result-item">
        <div class="label">VECCHIE (V)</div>
        <div class="value col-v" id="totV">0</div>
      </div>
    </div>
    
    <table class="detail-table">
      <thead>
        <tr><th>Taglio</th><th>N</th><th>V</th><th>Pezzi</th><th>Euro</th></tr>
      </thead>
      <tbody id="detailBody"></tbody>
    </table>
    
    <div class="targhette-detail">
      <h4>üìù Dettaglio Targhette Analizzate</h4>
      <div id="targhetteDetail"></div>
    </div>
    
    <button class="btn btn-success" onclick="mostraTarghetta()">üìÑ GENERA TARGHETTA</button>
    <button class="btn btn-secondary" onclick="reset()">üîÑ Nuova Scansione</button>
  </div>

  <!-- Targhetta Preview -->
  <div id="targhettaSection" class="card targhetta-section hidden">
    <div class="card-title no-print">üìÑ Targhetta Riepilogativa (5√ó15cm)</div>
    <div id="targhettaPreview"></div>
    <div class="btn-row no-print">
      <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Stampa</button>
      <button class="btn btn-email" onclick="scaricaImmagine()">üì• Salva PNG</button>
    </div>
  </div>

  <script>
    const LOGO_BASE64 = "icon-192.png";
    
    let imageData = null;
    let results = null;
    let currentMode = 'auto';
    let tipoManual = 'B';
    
    // Set today's date for manual input
    document.getElementById('manualData').valueAsDate = new Date();
    
    // Load API key from localStorage
    const savedApiKey = localStorage.getItem('gemini_api_key');
    if (savedApiKey) {
      document.getElementById('apiKey').value = savedApiKey;
      document.getElementById('apiSaved').classList.add('show');
    }
    
    // Save API key on change
    document.getElementById('apiKey').addEventListener('change', (e) => {
      localStorage.setItem('gemini_api_key', e.target.value);
      document.getElementById('apiSaved').classList.add('show');
    });
    
    // File input handlers
    document.getElementById('cameraInput').addEventListener('change', handleImageSelect);
    document.getElementById('fileInput').addEventListener('change', handleImageSelect);
    
    function handleImageSelect(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        imageData = e.target.result;
        document.getElementById('preview').src = imageData;
        document.getElementById('previewContainer').classList.remove('hidden');
        document.getElementById('analyzeBtn').classList.remove('hidden');
        document.getElementById('errorMsg').classList.add('hidden');
      };
      reader.readAsDataURL(file);
    }
    
    function removeImage() {
      imageData = null;
      document.getElementById('previewContainer').classList.add('hidden');
      document.getElementById('analyzeBtn').classList.add('hidden');
      document.getElementById('cameraInput').value = '';
      document.getElementById('fileInput').value = '';
    }
    
    async function analyzeImage() {
      const apiKey = document.getElementById('apiKey').value.trim();
      if (!apiKey) {
        showError('Inserisci la tua API Key Gemini');
        return;
      }
      if (!imageData) {
        showError('Seleziona un\'immagine');
        return;
      }
      
      document.getElementById('uploadSection').classList.add('hidden');
      document.getElementById('loadingSection').classList.remove('hidden');
      document.getElementById('errorMsg').classList.add('hidden');
      
      try {
        const base64Data = imageData.split(',')[1];
        
        const prompt = `Analizza questa immagine che contiene targhette di conteggio banconote italiane.

Ogni targhetta ha:
- Una banca (es. MPS, Intesa, etc.)
- Una data (formato GG/MM/AAAA)
- TRE RIQUADRI con le lettere B, L, L3 - UNO ha una X segnata (B=Buono, L=Logoro, L3)
- Tagli: 500, 200, 100, 50, 20, 10, 5
- Per 200 e 100: potrebbero esserci valori N (Nuove) e V (Vecchie) separati

Rispondi SOLO con JSON valido (nessun testo prima o dopo):
{
  "targhette": [
    {
      "banca": "nome",
      "data": "GG/MM/AAAA",
      "tipo": "B" o "L" o "L3",
      "valori": {
        "500": {"pezzi": numero},
        "200": {"pezzi": numero, "nuove": numero_o_0, "vecchie": numero_o_0},
        "100": {"pezzi": numero, "nuove": numero_o_0, "vecchie": numero_o_0},
        "50": {"pezzi": numero},
        "20": {"pezzi": numero},
        "10": {"pezzi": numero},
        "5": {"pezzi": numero}
      }
    }
  ]
}`;

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'x-goog-api-key': apiKey
          },
          body: JSON.stringify({
            contents: [{
              parts: [
                { text: prompt },
                { inline_data: { mime_type: 'image/jpeg', data: base64Data } }
              ]
            }]
          })
        });
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error.message || 'Errore API Gemini');
        }
        
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        
        if (!jsonMatch) {
          throw new Error('Risposta non valida. Riprova con una foto pi√π chiara.');
        }
        
        const parsed = JSON.parse(jsonMatch[0]);
        processResults(parsed);
        
      } catch (error) {
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('uploadSection').classList.remove('hidden');
        showError(error.message || 'Errore durante l\'analisi');
      }
    }
    
    function processResults(data) {
      const tagli = [500, 200, 100, 50, 20, 10, 5];
      
      // Check same type
      const types = data.targhette.map(t => t.tipo).filter(Boolean);
      const uniqueTypes = [...new Set(types)];
      if (uniqueTypes.length > 1) {
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('uploadSection').classList.remove('hidden');
        showError(`Le targhette non sono dello stesso tipo! Trovati: ${uniqueTypes.join(', ')}`);
        return;
      }
      
      const tipo = uniqueTypes[0] || 'B';
      const banca = data.targhette[0]?.banca || 'BANCA';
      const dataStr = data.targhette[0]?.data || new Date().toLocaleDateString('it-IT');
      
      // Calculate totals
      const totali = {};
      let totPezzi = 0, totEuro = 0, totN = 0, totV = 0;
      
      tagli.forEach(tag => {
        let pezzi = 0, nuove = 0, vecchie = 0;
        data.targhette.forEach(t => {
          const v = t.valori[tag];
          if (v) {
            pezzi += v.pezzi || 0;
            nuove += v.nuove || 0;
            vecchie += v.vecchie || 0;
          }
        });
        totali[tag] = { pezzi, nuove, vecchie, euro: pezzi * tag };
        totPezzi += pezzi;
        totEuro += pezzi * tag;
        totN += nuove;
        totV += vecchie;
      });
      
      results = {
        targhette: data.targhette,
        totali,
        tipo,
        banca,
        data: dataStr,
        totPezzi,
        totEuro,
        totN,
        totV
      };
      
      // Update UI
      document.getElementById('loadingSection').classList.add('hidden');
      document.getElementById('resultsSection').classList.remove('hidden');
      
      const badge = document.getElementById('tipoBadge');
      badge.textContent = tipo === 'B' ? 'BUONO' : tipo === 'L' ? 'LOGORO' : 'L3';
      badge.className = 'tipo-badge ' + tipo.toLowerCase();
      
      document.getElementById('totPezzi').textContent = totPezzi;
      document.getElementById('totEuro').textContent = '‚Ç¨' + totEuro.toLocaleString('it-IT');
      document.getElementById('totN').textContent = totN;
      document.getElementById('totV').textContent = totV;
      
      // Detail table
      let html = '';
      tagli.forEach(tag => {
        const t = totali[tag];
        const hasNV = tag === 200 || tag === 100;
        html += `<tr>
          <td>‚Ç¨${tag}</td>
          <td class="col-n">${hasNV ? t.nuove : '-'}</td>
          <td class="col-v">${hasNV ? t.vecchie : '-'}</td>
          <td>${t.pezzi}</td>
          <td>‚Ç¨${t.euro.toLocaleString('it-IT')}</td>
        </tr>`;
      });
      document.getElementById('detailBody').innerHTML = html;
      
      // Targhette detail
      let detailHtml = '';
      data.targhette.forEach((t, i) => {
        let sum = 0;
        tagli.forEach(tag => { sum += (t.valori[tag]?.pezzi || 0) * tag; });
        detailHtml += `<div class="targhetta-item">
          <span>Targhetta ${i + 1}: ${t.banca} - ${t.data}</span>
          <span>‚Ç¨${sum.toLocaleString('it-IT')}</span>
        </div>`;
      });
      document.getElementById('targhetteDetail').innerHTML = detailHtml;
      
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }
    
    function mostraTarghetta() {
      if (!results) return;
      
      const tagli = [500, 200, 100, 50, 20, 10, 5];
      let rows = '';
      tagli.forEach(tag => {
        const t = results.totali[tag];
        const hasNV = tag === 200 || tag === 100;
        rows += `<div class="t-row">
          <div class="t-col-taglio">${tag}</div>
          <div class="t-col-n">${hasNV ? t.nuove : '-'}</div>
          <div class="t-col-v">${hasNV ? t.vecchie : '-'}</div>
          <div class="t-col-pezzi">${t.pezzi}</div>
        </div>`;
      });
      
      const tipoClass = 'sel-' + results.tipo.toLowerCase();
      
      document.getElementById('targhettaPreview').innerHTML = `
        <div class="targhetta-preview">
          <div class="t-header">
            <img src="${LOGO_BASE64}" alt="Logo">
            <div class="banca">${results.banca}</div>
          </div>
          <div class="t-data"><strong>Data:</strong>&nbsp;${results.data}</div>
          <div class="t-tipo">
            <div class="${results.tipo === 'B' ? tipoClass : ''}">B ${results.tipo === 'B' ? '‚úì' : ''}</div>
            <div class="${results.tipo === 'L' ? tipoClass : ''}">L ${results.tipo === 'L' ? '‚úì' : ''}</div>
            <div class="${results.tipo === 'L3' ? tipoClass : ''}">L3 ${results.tipo === 'L3' ? '‚úì' : ''}</div>
          </div>
          <div class="t-table-head">
            <div class="t-col-taglio">TAGLIO</div>
            <div class="t-col-n">N</div>
            <div class="t-col-v">V</div>
            <div class="t-col-pezzi">PEZZI</div>
          </div>
          <div class="t-table-body">${rows}</div>
          <div class="t-total">
            <div class="t-col-taglio">TOT</div>
            <div class="t-col-n">${results.totN}</div>
            <div class="t-col-v">${results.totV}</div>
            <div class="t-col-pezzi">${results.totPezzi}</div>
          </div>
          <div class="t-footer">Somma ${results.targhette.length} targhette ‚Ä¢ ‚Ç¨${results.totEuro.toLocaleString('it-IT')}</div>
        </div>
      `;
      
      document.getElementById('targhettaSection').classList.remove('hidden');
      document.getElementById('targhettaSection').scrollIntoView({ behavior: 'smooth' });
    }
    
    async function scaricaImmagine() {
      if (!results) return;
      
      const targhetta = document.querySelector('.targhetta-preview');
      if (!targhetta) return;
      
      try {
        // Show loading
        const btn = document.querySelector('.btn-email');
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚è≥ Generazione...';
        btn.disabled = true;
        
        const canvas = await html2canvas(targhetta, {
          scale: 3,
          backgroundColor: '#ffffff',
          useCORS: true
        });
        
        // Convert to PNG and download
        const link = document.createElement('a');
        const tipoLabel = results.tipo === 'B' ? 'BUONO' : results.tipo === 'L' ? 'LOGORO' : 'L3';
        const dataFile = results.data.replace(/\//g, '-');
        link.download = `Targhetta_${results.banca}_${tipoLabel}_${dataFile}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        // Restore button
        btn.innerHTML = '‚úÖ Salvato!';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 2000);
        
      } catch (error) {
        console.error('Errore generazione immagine:', error);
        alert('Errore nella generazione dell\'immagine');
      }
    }
    
    function setMode(mode) {
      currentMode = mode;
      document.getElementById('modeAuto').classList.toggle('active', mode === 'auto');
      document.getElementById('modeManual').classList.toggle('active', mode === 'manual');
      
      document.getElementById('apiSection').classList.toggle('hidden', mode === 'manual');
      document.getElementById('uploadSection').classList.toggle('hidden', mode === 'manual');
      document.getElementById('manualSection').classList.toggle('hidden', mode === 'auto');
      
      // Hide results when switching
      document.getElementById('resultsSection').classList.add('hidden');
      document.getElementById('targhettaSection').classList.add('hidden');
    }
    
    function setTipoManual(t) {
      tipoManual = t;
      document.querySelectorAll('.tipo-btn').forEach(btn => {
        btn.classList.remove('active-b', 'active-l', 'active-l3');
        if (btn.dataset.tipo === t) {
          btn.classList.add('active-' + t.toLowerCase());
        }
      });
    }
    
    function showManualTab(n) {
      document.querySelectorAll('.targhetta-tab').forEach((tab, i) => {
        tab.classList.toggle('active', i === n - 1);
      });
      document.getElementById('manualTab1').classList.toggle('active', n === 1);
      document.getElementById('manualTab2').classList.toggle('active', n === 2);
    }
    
    function updateManualTotal(tab, taglio) {
      const n = parseInt(document.getElementById(`m${tab}_${taglio}n`).value) || 0;
      const v = parseInt(document.getElementById(`m${tab}_${taglio}v`).value) || 0;
      document.getElementById(`m${tab}_${taglio}`).value = n + v;
    }
    
    function getManualVal(id) {
      return parseInt(document.getElementById(id).value) || 0;
    }
    
    function calcolaManuale() {
      const banca = document.getElementById('manualBanca').value;
      const dataVal = document.getElementById('manualData').value;
      const data = dataVal ? dataVal.split('-').reverse().join('/') : new Date().toLocaleDateString('it-IT');
      
      const tagli = [500, 200, 100, 50, 20, 10, 5];
      const totali = {};
      let totPezzi = 0, totEuro = 0, totN = 0, totV = 0;
      
      const targhette = [
        { banca: banca, data: data, tipo: tipoManual, valori: {} },
        { banca: banca, data: data, tipo: tipoManual, valori: {} }
      ];
      
      tagli.forEach(tag => {
        let pezzi1 = getManualVal(`m1_${tag}`);
        let pezzi2 = getManualVal(`m2_${tag}`);
        let nuove = 0, vecchie = 0;
        
        if (tag === 200 || tag === 100) {
          const n1 = getManualVal(`m1_${tag}n`);
          const v1 = getManualVal(`m1_${tag}v`);
          const n2 = getManualVal(`m2_${tag}n`);
          const v2 = getManualVal(`m2_${tag}v`);
          pezzi1 = n1 + v1;
          pezzi2 = n2 + v2;
          nuove = n1 + n2;
          vecchie = v1 + v2;
          totN += nuove;
          totV += vecchie;
          
          targhette[0].valori[tag] = { pezzi: pezzi1, nuove: n1, vecchie: v1 };
          targhette[1].valori[tag] = { pezzi: pezzi2, nuove: n2, vecchie: v2 };
        } else {
          targhette[0].valori[tag] = { pezzi: pezzi1 };
          targhette[1].valori[tag] = { pezzi: pezzi2 };
        }
        
        const pezziTot = pezzi1 + pezzi2;
        totali[tag] = { pezzi: pezziTot, nuove, vecchie, euro: pezziTot * tag };
        totPezzi += pezziTot;
        totEuro += pezziTot * tag;
      });
      
      results = {
        targhette: targhette,
        totali,
        tipo: tipoManual,
        banca,
        data,
        totPezzi,
        totEuro,
        totN,
        totV
      };
      
      // Update UI (reuse same display logic)
      document.getElementById('resultsSection').classList.remove('hidden');
      
      const badge = document.getElementById('tipoBadge');
      badge.textContent = tipoManual === 'B' ? 'BUONO' : tipoManual === 'L' ? 'LOGORO' : 'L3';
      badge.className = 'tipo-badge ' + tipoManual.toLowerCase();
      
      document.getElementById('totPezzi').textContent = totPezzi;
      document.getElementById('totEuro').textContent = '‚Ç¨' + totEuro.toLocaleString('it-IT');
      document.getElementById('totN').textContent = totN;
      document.getElementById('totV').textContent = totV;
      
      let html = '';
      tagli.forEach(tag => {
        const t = totali[tag];
        const hasNV = tag === 200 || tag === 100;
        html += `<tr>
          <td>‚Ç¨${tag}</td>
          <td class="col-n">${hasNV ? t.nuove : '-'}</td>
          <td class="col-v">${hasNV ? t.vecchie : '-'}</td>
          <td>${t.pezzi}</td>
          <td>‚Ç¨${t.euro.toLocaleString('it-IT')}</td>
        </tr>`;
      });
      document.getElementById('detailBody').innerHTML = html;
      
      // Targhette detail
      let detailHtml = '';
      targhette.forEach((t, i) => {
        let sum = 0;
        tagli.forEach(tag => { sum += (t.valori[tag]?.pezzi || 0) * tag; });
        if (sum > 0) {
          detailHtml += `<div class="targhetta-item">
            <span>Targhetta ${i + 1}: ${t.banca} - ${t.data}</span>
            <span>‚Ç¨${sum.toLocaleString('it-IT')}</span>
          </div>`;
        }
      });
      document.getElementById('targhetteDetail').innerHTML = detailHtml || '<div style="color:#6ee7b7;font-size:12px">Nessuna targhetta con valori</div>';
      
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }
    
    function showError(msg) {
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.classList.remove('hidden');
    }
    
    function reset() {
      imageData = null;
      results = null;
      document.getElementById('previewContainer').classList.add('hidden');
      document.getElementById('analyzeBtn').classList.add('hidden');
      document.getElementById('resultsSection').classList.add('hidden');
      document.getElementById('targhettaSection').classList.add('hidden');
      document.getElementById('uploadSection').classList.remove('hidden');
      document.getElementById('cameraInput').value = '';
      document.getElementById('fileInput').value = '';
      
      // Reset manual inputs
      [1, 2].forEach(tab => {
        [500, 50, 20, 10, 5].forEach(tag => {
          const el = document.getElementById(`m${tab}_${tag}`);
          if (el) el.value = 0;
        });
        [200, 100].forEach(tag => {
          const nEl = document.getElementById(`m${tab}_${tag}n`);
          const vEl = document.getElementById(`m${tab}_${tag}v`);
          const tEl = document.getElementById(`m${tab}_${tag}`);
          if (nEl) nEl.value = 0;
          if (vEl) vEl.value = 0;
          if (tEl) tEl.value = '';
        });
      });
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  </script>
</body>
</html>
